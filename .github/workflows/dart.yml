name: iOS-ipa-build

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-ios:
    name: ğŸ‰ iOS Build
    runs-on: macos-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          architecture: x64

      - name: Install dependencies
        run: flutter pub get

      - name: Cache CocoaPods
        uses: actions/cache@v3
        with:
          path: |
            ios/Pods
            ~/Library/Caches/CocoaPods
            ~/.cocoapods
          key: ${{ runner.os }}-pods-${{ hashFiles('**/Podfile.lock') }}
          restore-keys: |
            ${{ runner.os }}-pods-

      - name: Setup CocoaPods
        timeout-minutes: 15
        run: |
          cd ios
          echo "ğŸ” Checking CocoaPods version..."
          pod --version
          echo "ğŸ“¦ Updating CocoaPods repo..."
          pod repo update --verbose || echo "âš ï¸ pod repo update had issues, continuing anyway..."
          echo "ğŸ“¥ Installing pods..."
          pod install --repo-update --verbose
          echo "âœ… Pod install completed!"

      - name: Configure Xcode for no-code signing
        run: |
          cd ios
          python3 << 'EOF'
          import re
          
          # Read the project file
          with open('Runner.xcodeproj/project.pbxproj', 'r') as f:
              content = f.read()
          
          # Disable code signing completely
          replacements = [
              (r'DEVELOPMENT_TEAM = [^;]+;', 'DEVELOPMENT_TEAM = "";'),
              (r'CODE_SIGN_IDENTITY = "[^"]+";', 'CODE_SIGN_IDENTITY = "";'),
              (r'"CODE_SIGN_IDENTITY\[sdk=iphoneos\*\]" = "[^"]+";', '"CODE_SIGN_IDENTITY[sdk=iphoneos*]" = "";'),
              (r'CODE_SIGN_STYLE = Automatic;', 'CODE_SIGN_STYLE = Manual;'),
              (r'ProvisioningStyle = Automatic;', 'ProvisioningStyle = Manual;'),
              (r'CODE_SIGNING_REQUIRED = YES;', 'CODE_SIGNING_REQUIRED = NO;'),
              (r'CODE_SIGNING_ALLOWED = YES;', 'CODE_SIGNING_ALLOWED = NO;'),
          ]
          
          for pattern, replacement in replacements:
              content = re.sub(pattern, replacement, content)
          
          # Write back
          with open('Runner.xcodeproj/project.pbxproj', 'w') as f:
              f.write(content)
          
          print("âœ… Code signing disabled in Xcode project")
          EOF

      - name: Build iOS with xcodebuild directly
        timeout-minutes: 30
        run: |
          cd ios
          echo "ğŸ§¹ Cleaning previous build..."
          xcodebuild clean -workspace Runner.xcworkspace -scheme Runner || true
          
          echo "ğŸ”¨ Building iOS app without code signing..."
          # Build with explicit derivedDataPath to control output location
          xcodebuild build \
            -workspace Runner.xcworkspace \
            -scheme Runner \
            -configuration Release \
            -sdk iphoneos \
            -destination 'generic/platform=iOS' \
            -derivedDataPath ./build \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO \
            DEVELOPMENT_TEAM="" \
            PROVISIONING_PROFILE_SPECIFIER="" \
            PROVISIONING_PROFILE="" \
            ONLY_ACTIVE_ARCH=NO
            
          echo "ğŸ“¦ Searching for build output..."
          mkdir -p ../build/ios/iphoneos
          
          # Try multiple possible locations
          RUNNER_APP=""
          
          # Check in explicit build directory
          if [ -d "build/Build/Products/Release-iphoneos/Runner.app" ]; then
            RUNNER_APP="build/Build/Products/Release-iphoneos/Runner.app"
            echo "âœ… Found Runner.app in build/Build/Products/Release-iphoneos/"
          elif [ -d "build/Release-iphoneos/Runner.app" ]; then
            RUNNER_APP="build/Release-iphoneos/Runner.app"
            echo "âœ… Found Runner.app in build/Release-iphoneos/"
          else
            echo "âš ï¸ Searching in DerivedData..."
            # Search in DerivedData (default location)
            DERIVED_DATA=$(find ~/Library/Developer/Xcode/DerivedData -name "Runner.app" -type d -path "*/Build/Products/Release-iphoneos/*" 2>/dev/null | head -1)
            if [ -n "$DERIVED_DATA" ]; then
              RUNNER_APP="$DERIVED_DATA"
              echo "âœ… Found Runner.app in DerivedData: $DERIVED_DATA"
            else
              echo "âš ï¸ Searching in current directory..."
              # Search anywhere in ios directory
              RUNNER_APP=$(find . -name "Runner.app" -type d | head -1)
              if [ -n "$RUNNER_APP" ]; then
                echo "âœ… Found Runner.app at: $RUNNER_APP"
              fi
            fi
          fi
          
          if [ -z "$RUNNER_APP" ] || [ ! -d "$RUNNER_APP" ]; then
            echo "âŒ Runner.app not found anywhere!"
            echo "ğŸ“‚ Listing build directory:"
            ls -la build/ || true
            echo "ğŸ“‚ Searching for any .app files:"
            find . -name "*.app" -type d 2>/dev/null | head -10 || true
            exit 1
          fi
          
          echo "ğŸ“‹ Copying Runner.app from: $RUNNER_APP"
          cp -R "$RUNNER_APP" ../build/ios/iphoneos/Runner.app
          echo "âœ… Build copied successfully!"
          echo "ğŸ” Verifying copied file..."
          ls -la ../build/ios/iphoneos/Runner.app || exit 1

      - name: Create Payload and prepare IPA
        run: |
          cd build/ios/iphoneos
          echo "ğŸ” Checking if Runner.app exists..."
          if [ ! -d "Runner.app" ]; then
            echo "âŒ Runner.app not found in build/ios/iphoneos/"
            echo "ğŸ“‚ Listing contents:"
            ls -la
            exit 1
          fi
          echo "âœ… Runner.app found!"
          echo "ğŸ“¦ Creating Payload directory..."
          mkdir -p Payload
          echo "ğŸ“ Moving Runner.app to Payload..."
          mv Runner.app Payload/
          echo "ğŸ“¦ Creating IPA file..."
          zip -qq -r -9 FlutterIpaExport.ipa Payload
          echo "âœ… IPA file created successfully!"
          ls -lh FlutterIpaExport.ipa

      - name: Upload to release
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          file: build/ios/iphoneos/FlutterIpaExport.ipa
          tag: v1.0
          overwrite: true
          body: "This is first release"

