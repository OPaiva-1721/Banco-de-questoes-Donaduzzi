name: iOS-ipa-build

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-ios:
    name: üéâ iOS Build
    runs-on: macos-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          architecture: x64

      - name: Install dependencies
        run: flutter pub get

      - name: Cache CocoaPods
        uses: actions/cache@v3
        with:
          path: |
            ios/Pods
            ~/Library/Caches/CocoaPods
            ~/.cocoapods
          key: ${{ runner.os }}-pods-${{ hashFiles('**/Podfile.lock') }}
          restore-keys: |
            ${{ runner.os }}-pods-

      - name: Setup CocoaPods
        timeout-minutes: 15
        run: |
          cd ios
          echo "üîç Checking CocoaPods version..."
          pod --version
          echo "üì¶ Updating CocoaPods repo..."
          pod repo update --verbose || echo "‚ö†Ô∏è pod repo update had issues, continuing anyway..."
          echo "üì• Installing pods..."
          pod install --repo-update --verbose
          echo "‚úÖ Pod install completed!"

      - name: Configure Xcode for no-code signing
        run: |
          cd ios
          python3 << 'EOF'
          import re
          
          # Read the project file
          with open('Runner.xcodeproj/project.pbxproj', 'r') as f:
              content = f.read()
          
          # Disable code signing completely
          replacements = [
              (r'DEVELOPMENT_TEAM = [^;]+;', 'DEVELOPMENT_TEAM = "";'),
              (r'CODE_SIGN_IDENTITY = "[^"]+";', 'CODE_SIGN_IDENTITY = "";'),
              (r'"CODE_SIGN_IDENTITY\[sdk=iphoneos\*\]" = "[^"]+";', '"CODE_SIGN_IDENTITY[sdk=iphoneos*]" = "";'),
              (r'CODE_SIGN_STYLE = Automatic;', 'CODE_SIGN_STYLE = Manual;'),
              (r'ProvisioningStyle = Automatic;', 'ProvisioningStyle = Manual;'),
              (r'CODE_SIGNING_REQUIRED = YES;', 'CODE_SIGNING_REQUIRED = NO;'),
              (r'CODE_SIGNING_ALLOWED = YES;', 'CODE_SIGNING_ALLOWED = NO;'),
          ]
          
          for pattern, replacement in replacements:
              content = re.sub(pattern, replacement, content)
          
          # Write back
          with open('Runner.xcodeproj/project.pbxproj', 'w') as f:
              f.write(content)
          
          print("‚úÖ Code signing disabled in Xcode project")
          EOF

      - name: Build iOS with xcodebuild directly
        timeout-minutes: 30
        run: |
          cd ios
          echo "üßπ Cleaning previous build..."
          xcodebuild clean -workspace Runner.xcworkspace -scheme Runner -quiet || true
          
          echo "üî® Building iOS app without code signing..."
          xcodebuild build \
            -workspace Runner.xcworkspace \
            -scheme Runner \
            -configuration Release \
            -sdk iphoneos \
            -destination 'generic/platform=iOS' \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO \
            DEVELOPMENT_TEAM="" \
            PROVISIONING_PROFILE_SPECIFIER="" \
            PROVISIONING_PROFILE="" \
            ONLY_ACTIVE_ARCH=NO \
            -quiet
            
          echo "üì¶ Copying build output..."
          mkdir -p ../build/ios/iphoneos
          if [ -d "build/Release-iphoneos/Runner.app" ]; then
            echo "‚úÖ Found Runner.app in build/Release-iphoneos/"
            cp -R build/Release-iphoneos/Runner.app ../build/ios/iphoneos/Runner.app
            echo "‚úÖ Build completed successfully!"
          else
            echo "‚ö†Ô∏è Build output not found in build/Release-iphoneos/, searching..."
            RUNNER_APP=$(find . -name "Runner.app" -type d | head -1)
            if [ -n "$RUNNER_APP" ]; then
              echo "‚úÖ Found Runner.app at: $RUNNER_APP"
              cp -R "$RUNNER_APP" ../build/ios/iphoneos/Runner.app
              echo "‚úÖ Build copied successfully!"
            else
              echo "‚ùå Runner.app not found anywhere!"
              echo "üìÇ Listing build directory:"
              ls -la build/ || true
              exit 1
            fi
          fi
          echo "üîç Verifying copied file..."
          ls -la ../build/ios/iphoneos/Runner.app || exit 1

      - name: Create Payload and prepare IPA
        run: |
          cd build/ios/iphoneos
          echo "üîç Checking if Runner.app exists..."
          if [ ! -d "Runner.app" ]; then
            echo "‚ùå Runner.app not found in build/ios/iphoneos/"
            echo "üìÇ Listing contents:"
            ls -la
            exit 1
          fi
          echo "‚úÖ Runner.app found!"
          echo "üì¶ Creating Payload directory..."
          mkdir -p Payload
          echo "üìÅ Moving Runner.app to Payload..."
          mv Runner.app Payload/
          echo "üì¶ Creating IPA file..."
          zip -qq -r -9 FlutterIpaExport.ipa Payload
          echo "‚úÖ IPA file created successfully!"
          ls -lh FlutterIpaExport.ipa

      - name: Upload to release
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          file: build/ios/iphoneos/FlutterIpaExport.ipa
          tag: v1.0
          overwrite: true
          body: "This is first release"

